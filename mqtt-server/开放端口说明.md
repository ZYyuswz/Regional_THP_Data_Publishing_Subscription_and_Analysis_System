# 阿里云轻量应用服务器开放端口指南

## 1. 在阿里云控制台配置安全组

### 步骤：

1. **登录阿里云控制台**
   - 访问：https://ecs.console.aliyun.com/
   - 或直接访问轻量应用服务器控制台

2. **进入服务器管理页面**
   - 找到你的轻量应用服务器实例
   - 点击服务器名称进入详情页

3. **配置防火墙/安全组**
   - 在左侧菜单找到 **"防火墙"** 或 **"安全组"** 选项
   - 点击 **"添加规则"** 或 **"创建规则"**

4. **添加端口规则**
   - **规则名称**：MQTT WebSocket（可选）
   - **协议类型**：TCP
   - **端口范围**：8083/8083（或 8083）
   - **授权对象**：0.0.0.0/0（允许所有 IP，或指定特定 IP）
   - **策略**：允许
   - **优先级**：1（数字越小优先级越高）

5. **同时开放其他需要的端口**
   - **3000**：Flask API 端口
   - **1883**：MQTT 标准端口（如果使用）
   - **8083**：MQTT WebSocket 端口（必须）

6. **保存规则**
   - 点击 **"确定"** 或 **"保存"**
   - 规则通常立即生效

## 2. 在服务器上配置本地防火墙（如果需要）

### 如果使用 firewalld（CentOS/RHEL）：

```bash
# 检查防火墙状态
sudo systemctl status firewalld

# 如果防火墙运行中，添加端口
sudo firewall-cmd --permanent --add-port=8083/tcp
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --permanent --add-port=1883/tcp

# 重新加载防火墙规则
sudo firewall-cmd --reload

# 验证端口是否开放
sudo firewall-cmd --list-ports
```

### 如果使用 ufw（Ubuntu/Debian）：

```bash
# 检查防火墙状态
sudo ufw status

# 开放端口
sudo ufw allow 8083/tcp
sudo ufw allow 3000/tcp
sudo ufw allow 1883/tcp

# 如果防火墙未启用，启用它
sudo ufw enable

# 验证
sudo ufw status
```

### 如果使用 iptables：

```bash
# 开放端口
sudo iptables -A INPUT -p tcp --dport 8083 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 3000 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 1883 -j ACCEPT

# 保存规则（根据系统不同）
# CentOS/RHEL:
sudo service iptables save
# 或
sudo /sbin/iptables-save > /etc/sysconfig/iptables

# Ubuntu/Debian:
sudo iptables-save > /etc/iptables/rules.v4
```

## 3. 验证端口是否开放

### 方法 1：在服务器上检查端口监听

```bash
# 检查端口是否在监听
sudo netstat -tulpn | grep 8083
# 或
sudo ss -tulpn | grep 8083

# 应该看到类似输出：
# tcp6  0  0 :::8083  :::*  LISTEN  1234/mosquitto
```

### 方法 2：从外部测试连接

```bash
# 在本地电脑或其他服务器上测试
telnet 139.224.192.45 8083
# 或
nc -zv 139.224.192.45 8083
```

### 方法 3：使用在线工具

- 访问：https://tool.chinaz.com/port
- 输入你的公网 IP：139.224.192.45
- 输入端口：8083
- 点击检测

## 4. 检查 Mosquitto 配置

确保 Mosquitto 配置了 WebSocket 监听器：

```bash
# 查看 Mosquitto 配置文件
sudo cat /etc/mosquitto/mosquitto.conf
# 或
sudo cat /usr/local/etc/mosquitto/mosquitto.conf
```

应该包含类似配置：

```
listener 1883
protocol mqtt

listener 8083
protocol websockets
```

## 5. 重启 Mosquitto 服务

```bash
# 重启服务使配置生效
sudo systemctl restart mosquitto
# 或
sudo service mosquitto restart

# 检查服务状态
sudo systemctl status mosquitto
```

## 常见问题

### Q: 配置了安全组但还是连不上？
A: 检查：
1. 服务器本地防火墙是否也开放了端口
2. Mosquitto 是否真的在监听 8083 端口
3. Mosquitto 配置文件是否正确

### Q: 如何查看防火墙是否运行？
A: 
```bash
# firewalld
sudo systemctl status firewalld

# ufw
sudo ufw status

# 查看所有防火墙规则
sudo iptables -L -n
```

### Q: 不想用防火墙怎么办？
A: 可以临时关闭（不推荐生产环境）：
```bash
# firewalld
sudo systemctl stop firewalld
sudo systemctl disable firewalld

# ufw
sudo ufw disable
```


